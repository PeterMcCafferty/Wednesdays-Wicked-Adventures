name: SAST Security Scan

on:
  push:
    branches: [ main, UAT ]
  pull_request:
    branches: [ main ]

jobs:
  bandit-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Install Bandit
      run: pip install bandit
        
    - name: Run Bandit SAST scan
      run: |
        bandit -c .bandit.yml -r . -f json -o bandit-results.json
        
        # Check for all results
        if [ -f bandit-results.json ]; then
          echo "=== SAST Analysis Summary ==="
          
          ALL_ISSUES=$(python -c "
          import json
          try:
              with open('bandit-results.json') as f:
                  data = json.load(f)
                  
                  # Count by severity
                  severities = {'HIGH': 0, 'MEDIUM': 0, 'LOW': 0, 'UNDEFINED': 0}
                  for issue in data['results']:
                      sev = issue.get('issue_severity', 'UNDEFINED')
                      severities[sev] = severities.get(sev, 0) + 1
                  
                  # Print summary
                  for sev in ['HIGH', 'MEDIUM', 'LOW', 'UNDEFINED']:
                      print(severities.get(sev, 0))
          except Exception as e:
              print('0\\n0\\n0\\n0')
          ")
          
          # Read the output (4 numbers: HIGH, MEDIUM, LOW, UNDEFINED)
          IFS=$'\n' read -r HIGH MEDIUM LOW UNDEFINED <<< "$ALL_ISSUES"
          
          echo "HIGH: $HIGH | MEDIUM: $MEDIUM | LOW: $LOW | UNDEFINED: $UNDEFINED"
          
          # Fail only on HIGH/MEDIUM
          TOTAL_CRITICAL=$((HIGH + MEDIUM))
          
          if [ "$TOTAL_CRITICAL" -gt 0 ]; then
            echo "❌ Found $TOTAL_CRITICAL HIGH/MEDIUM vulnerabilities"
            echo "Check bandit-results.json for details"
            exit 1
          else
            echo "✅ No HIGH/MEDIUM vulnerabilities found"
            if [ "$LOW" -gt 0 ]; then
              echo "⚠️  Found $LOW LOW severity issues (review recommended)"
            fi
          fi
        fi
      
    - name: Upload scan results
      uses: actions/upload-artifact@v4
      with:
        name: bandit-results
        path: bandit-results.json