# ============================================================
# BUILD WORKFLOW
#
# This workflow VERIFIES the application build using dependencies
# already installed by setup-environment. It MUST NOT install anything.
# ============================================================

name: Build App

on:
  workflow_call:
    inputs:
      python-version:
        description: "Python version to use for building"
        required: true
        type: string
      working-directory:
        description: "Directory of the app to build"
        required: true
        type: string
      dependencies-installed:
        description: "Indicates if dependencies are already installed from setup-environment"
        required: false
        type: boolean
        default: false
      cache-key:
        description: "Cache key from setup-environment for dependency cache"
        required: false
        type: string
        default: ""

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Reduced since no installation needed
    
    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      # Step 3: Restore Python dependencies cache
      - name: Restore Python dependencies cache
        if: ${{ inputs.dependencies-installed && inputs.cache-key != '' }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            /opt/hostedtoolcache/Python
          key: ${{ inputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-python-${{ inputs.python-version }}-deps-

      # Step 4: Verify or install dependencies
      - name: Verify dependencies or install
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "üîß BUILD PHASE"
          echo "============="
          echo "This step VERIFIES that all previous steps succeeded."
          echo "It will FAIL if dependencies are not properly installed."
          echo ""
          
          # CRITICAL: Se dependencies-installed √© true, DEVE ter tudo instalado
          if [ "${{ inputs.dependencies-installed }}" = "true" ]; then
            echo "‚úÖ setup-environment executed successfully"
            echo "Checking if ALL required packages are installed..."
            
            # Lista de pacotes ESSENCIAIS que DEVERIAM estar instalados
            ESSENTIAL_PACKAGES="Flask flask-sqlalchemy pymysql flask-login setuptools"
            MISSING_PACKAGES=0
            
            for pkg in $ESSENTIAL_PACKAGES; do
              if pip show "$pkg" >/dev/null 2>&1; then
                version=$(pip show "$pkg" | grep "^Version:" | cut -d: -f2 | xargs)
                echo "  ‚úÖ $pkg==$version"
              else
                echo "  ‚ùå $pkg - NOT INSTALLED"
                echo "     This indicates setup-environment FAILED!"
                MISSING_PACKAGES=$((MISSING_PACKAGES + 1))
              fi
            done
            
            echo ""
            if [ $MISSING_PACKAGES -gt 0 ]; then
              echo "üíÄ BUILD VERIFICATION FAILED!"
              echo "   $MISSING_PACKAGES essential packages are MISSING"
              echo "   Previous steps (setup-environment/smoke-test) should have installed them"
              echo "   Check setup-environment and smoke-test logs for errors"
              exit 1
            else
              echo "‚úÖ ALL essential packages are installed"
              echo "‚úÖ Previous pipeline steps succeeded"
            fi
          
          else
            echo "‚ö†Ô∏è dependencies-installed is false"
            echo "This build job requires setup-environment to run first"
            echo "Please run via pipeline.yaml with dependencies-installed: true"
            exit 1
          fi

      # Step 5: Perform build verification
      - name: Verify Flask application
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "üîç Verifying Flask application..."
          echo "Working directory: $(pwd)"
          echo ""
          echo "This is the FINAL verification that everything works."
          
          # Check if app package exists
          if [ -d "app" ] && [ -f "app/__init__.py" ]; then
            echo "‚úÖ Found app package with __init__.py"
          else
            echo "‚ùå app package not found in $(pwd)"
            echo "   Directory contents:"
            ls -la
            exit 1
          fi
          
          python3 << 'EOF'
          import sys
          
          try:
              print("üîß FINAL APPLICATION VERIFICATION")
              print("=" * 40)
              print(f"Python path: {sys.path}")
              
              # Try to import
              from app import create_app
              print("‚úÖ Module import successful")
              
              # Create app in testing mode
              app = create_app('testing')
              print(f"‚úÖ App created: {app.name}")
              
              # Verify critical configurations
              if not app.config.get('SECRET_KEY'):
                  print("‚ùå SECRET_KEY missing - Critical configuration error")
                  sys.exit(1)
                  
              if not app.config.get('SQLALCHEMY_DATABASE_URI'):
                  print("‚ùå Database URI missing - Database not configured")
                  sys.exit(1)
                  
              print("‚úÖ All critical configurations present")
              
              # Test a simple route
              with app.test_client() as client:
                  response = client.get('/')
                  print(f"‚úÖ Route test successful: HTTP {response.status_code}")
                  
          except ImportError as e:
              print(f"‚ùå IMPORT ERROR: {e}")
              print("This indicates missing dependencies or broken imports")
              sys.exit(1)
          except Exception as e:
              print(f"‚ùå APPLICATION ERROR: {type(e).__name__}: {str(e)[:200]}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          
          print("=" * 40)
          print("üéâ FINAL VERIFICATION PASSED!")
          print("‚úÖ All dependencies installed correctly")
          print("‚úÖ Application imports work")
          print("‚úÖ Configuration loaded successfully")
          print("‚úÖ Routes respond correctly")
          print("")
          print("üöÄ APPLICATION IS READY FOR DEPLOYMENT")
          EOF
          
          echo "‚úÖ Flask application verified successfully"

      # Step 6: Upload build artifacts
      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            ${{ inputs.working-directory }}/
          retention-days: 7

      # Step 7: Build success notification
      - name: Build verification passed
        if: success()
        run: |
          echo ""
          echo "üèÜ BUILD VERIFICATION COMPLETE"
          echo "=============================="
          echo "‚úÖ All previous pipeline steps verified:"
          echo "   - setup-environment: Installed dependencies ‚úì"
          echo "   - smoke-test: Basic functionality works ‚úì"
          echo "   - security-sast: Security scan completed ‚úì"
          echo "   - build-app: Final verification passed ‚úì"
          echo ""
          echo "üì¶ Application is fully verified and ready"
          echo "üéØ Pipeline execution: SUCCESS"