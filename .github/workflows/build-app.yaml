# ============================================================
# BUILD WORKFLOW
#
# This workflow VERIFIES the application build using dependencies
# already installed by setup-environment. It MUST NOT install anything.
# ============================================================

name: Build App

on:
  workflow_call:
    inputs:
      python-version:
        description: "Python version to use for building"
        required: true
        type: string
      working-directory:
        description: "Directory of the app to build"
        required: true
        type: string
      dependencies-installed:
        description: "Indicates if dependencies are already installed from setup-environment"
        required: false
        type: string
        default: "false"
      cache-key:
        description: "Cache key from setup-environment for dependency cache"
        required: false
        type: string
        default: ""

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Reduced since no installation needed
    
    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      # Step 3: Restore Python dependencies cache
      - name: Restore Python dependencies cache
        if: ${{ inputs.dependencies-installed == 'true' && inputs.cache-key != '' }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            /opt/hostedtoolcache/Python
          key: ${{ inputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-python-${{ inputs.python-version }}-deps-

      # Step 4: Verify or install dependencies
      - name: Verify dependencies or install
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "üîß BUILD PHASE"
          echo "============="
          echo "This step VERIFIES that all previous steps succeeded."
          echo "It will FAIL if dependencies are not properly installed."
          echo ""
          
          # CRITICAL: Se dependencies-installed √© true, DEVE ter tudo instalado
          if [ "${{ inputs.dependencies-installed }}" = "true" ]; then  # ‚¨ÖÔ∏è J√° est√° correto
            echo "‚úÖ setup-environment executed successfully"
            echo "Checking if ALL required packages are installed..."
            
            # Lista de pacotes ESSENCIAIS que DEVERIAM estar instalados
            ESSENTIAL_PACKAGES="Flask flask-sqlalchemy pymysql flask-login setuptools"
            MISSING_PACKAGES=0
            
            for pkg in $ESSENTIAL_PACKAGES; do
              if pip show "$pkg" >/dev/null 2>&1; then
                version=$(pip show "$pkg" | grep "^Version:" | cut -d: -f2 | xargs)
                echo "  ‚úÖ $pkg==$version"
              else
                echo "  ‚ùå $pkg - NOT INSTALLED"
                echo "     This indicates setup-environment FAILED!"
                MISSING_PACKAGES=$((MISSING_PACKAGES + 1))
              fi
            done
            
            echo ""
            if [ $MISSING_PACKAGES -gt 0 ]; then
              echo "üíÄ BUILD VERIFICATION FAILED!"
              echo "   $MISSING_PACKAGES essential packages are MISSING"
              echo "   Previous step (setup-environment) should have installed them"
              echo "   Check setup-environment logs for errors"
              exit 1
            else
              echo "‚úÖ ALL essential packages are installed"
              echo "‚úÖ Previous pipeline steps succeeded"
            fi
          
          else
            echo "‚ö†Ô∏è dependencies-installed is ${{ inputs.dependencies-installed }}"
            echo "This build job requires setup-environment to run first"
            echo "Please run via pipeline.yaml with dependencies-installed: true"
            exit 1
          fi

      - name: Verify Flask application
        working-directory: ${{ inputs.working-directory }}
        env:
          PYTHONPATH: "${{ inputs.working-directory }}:${{ github.workspace }}"
        run: |
          echo "üîç Final Flask application verification..."
          echo "Working directory: $(pwd)"
          echo "PYTHONPATH: $PYTHONPATH"
          echo ""
          
          python3 << 'EOF'
          import sys
          import os
          
          print("üîß FINAL APPLICATION VERIFICATION")
          print("=" * 40)
          
          try:
              # Importa a aplica√ß√£o
              from main.app import create_app
              print("‚úÖ Successfully imported create_app from main.app")
              
              # Cria app em modo testing
              app = create_app('testing')
              print(f"‚úÖ Flask app created: {app.name}")
              
              # Verifica√ß√£o b√°sica
              print(f"\nüìã Basic app info:")
              print(f"   Testing mode: {app.config.get('TESTING', False)}")
              print(f"   Debug mode: {app.config.get('DEBUG', False)}")
              print(f"   Config keys: {len(app.config)}")
              
              # Verifica se app tem configura√ß√£o b√°sica
              if not app.config.get('SECRET_KEY'):
                  print("‚ö†Ô∏è WARNING: SECRET_KEY not set (might be expected in testing)")
              
              # Verifica se app tem rotas definidas
              print(f"\nüåê Checking app routes...")
              routes = list(app.url_map.iter_rules())
              print(f"   Found {len(routes)} routes")
              
              if routes:
                  # Testa a primeira rota n√£o interna
                  for route in routes:
                      if not route.rule.startswith('/_') and len(route.rule) > 1:
                          print(f"   Sample route: {route.rule}")
                          break
                  
                  # Testa se app pode responder
                  print("\nüß™ Testing app response capability...")
                  with app.test_client() as client:
                      # Tenta acessar uma rota existente ou verifica app health
                      response = client.get('/')
                      print(f"   Root endpoint status: {response.status_code}")
                      
                      # Se 404, pode ser normal (app pode n√£o ter rota raiz)
                      if response.status_code != 404:
                          print(f"‚úÖ App responds with status {response.status_code}")
                      else:
                          print("‚ÑπÔ∏è Root endpoint returns 404 (might be expected)")
                          
                      # Verifica estrutura b√°sica do app
                      print(f"\n‚úÖ App verification passed")
              else:
                  print("‚ö†Ô∏è WARNING: No routes defined in application")
              
          except ImportError as e:
              print(f"\n‚ùå IMPORT ERROR: {e}")
              print("This should have been caught by setup-environment!")
              sys.exit(1)
          except Exception as e:
              print(f"\n‚ùå APPLICATION ERROR: {type(e).__name__}: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          
          print("\n" + "=" * 40)
          print("üéâ BUILD VERIFICATION PASSED!")
          print("‚úÖ Application imports work")
          print("‚úÖ App can be instantiated")
          print("‚úÖ App structure is valid")
          print("")
          print("üöÄ APPLICATION IS READY FOR DEPLOYMENT")
          EOF
          
          echo "‚úÖ Final verification completed successfully"