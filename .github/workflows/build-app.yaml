# ============================================================
# BUILD WORKFLOW
#
# This workflow builds the application using dependencies
# already installed by setup-environment.
# ============================================================

name: Build App

on:
  workflow_call:
    inputs:
      python-version:
        description: "Python version to use for building"
        required: true
        type: string
      working-directory:
        description: "Directory of the app to build"
        required: true
        type: string
      dependencies-installed:
        description: "Indicates if dependencies are already installed from setup-environment"
        required: false
        type: boolean
        default: false
      cache-key:
        description: "Cache key from setup-environment for dependency cache"
        required: false
        type: string
        default: ""

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Reduced since no installation needed
    
    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Set up Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      # Step 3: Restore Python dependencies cache
      - name: Restore Python dependencies cache
        if: ${{ inputs.dependencies-installed && inputs.cache-key != '' }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            /opt/hostedtoolcache/Python
          key: ${{ inputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-python-${{ inputs.python-version }}-deps-

      # Step 4: Verify or install dependencies
      - name: Verify dependencies or install
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "üîß BUILD PHASE"
          echo "============="
          
          if [ "${{ inputs.dependencies-installed }}" = "true" ] && [ -n "${{ inputs.cache-key }}" ]; then
            echo "‚úÖ Using dependencies from setup-environment"
            echo "Verifying build requirements..."
            
            # Check if basic build requirements are available
            REQUIRED_FOR_BUILD="Flask setuptools"
            for pkg in $REQUIRED_FOR_BUILD; do
              if pip show "$pkg" >/dev/null 2>&1; then
                version=$(pip show "$pkg" | grep "^Version:" | cut -d: -f2 | xargs)
                echo "  ‚úÖ $pkg==$version"
              else
                echo "  ‚ö†Ô∏è $pkg not found in cache, installing..."
                pip install "$pkg"
              fi
            done
            
            echo "‚úÖ All build dependencies verified"
          else
            echo "‚ö†Ô∏è Running in standalone mode (without setup-environment)"
            echo "Installing build dependencies..."
            
            python -m pip install --upgrade pip
            
            if [ -f "requirements.txt" ]; then
              echo "Installing from requirements.txt"
              pip install -r requirements.txt
            else
              echo "No requirements.txt found, installing project in development mode"
              pip install -e .
            fi
          fi

      # Step 5: Perform build steps
      - name: Verify Flask application
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "üîç Verifying Flask application..."
          echo "Working directory: $(pwd)"
          
          # Check if app package exists
          if [ -d "app" ] && [ -f "app/__init__.py" ]; then
            echo "‚úÖ Found app package with __init__.py"
          else
            echo "‚ùå app package not found in $(pwd)"
            ls -la
            exit 1
          fi
          
          python3 << 'EOF'
          import sys
          
          try:
              # Current directory should be flask_app/src/main
              # app package is inside it
              print(f"Python path: {sys.path}")
              
              from app import create_app
              
              # Create app in testing mode
              app = create_app('testing')
              print(f"‚úÖ App created: {app.name}")
              
              # Test a simple route without running server
              with app.test_client() as client:
                  response = client.get('/')
                  print(f"‚úÖ Route test: HTTP {response.status_code}")
                  
                  if response.status_code in [200, 302, 404]:
                      print("‚úÖ App responds correctly")
                  else:
                      print(f"‚ö†Ô∏è Unexpected status: {response.status_code}")
                      
          except Exception as e:
              print(f"‚ùå App verification failed: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          EOF
          
          echo "‚úÖ Flask application verified successfully"

      # Step 6: Upload build artifacts
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            ${{ inputs.working-directory }}/
          retention-days: 7