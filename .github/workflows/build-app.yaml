# ============================================================
# BUILD WORKFLOW
#
# This workflow VERIFIES the application build using dependencies
# already installed by setup-environment. It MUST NOT install anything.
# ============================================================

name: Build App

on:
  workflow_call:
    inputs:
      project-root:
        description: "Project root directory from setup-environment"
        required: true
        type: string
      venv-path:
        description: "Path to virtual environment"
        required: true
        type: string
      python-path:
        description: "Path to Python executable in venv"
        required: true
        type: string
      working-directory:
        description: "Directory of the app to build (for compatibility)"
        required: false
        type: string
        default: ""


jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Reduced since no installation needed
    
    env:
      VENV_PYTHON: ${{ inputs.python-path }}
      VENV_PIP: ${{ inputs.venv-path }}/bin/pip
      VENV_PATH: ${{ inputs.venv-path }}
      PROJECT_ROOT: ${{ inputs.project-root }}

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: VERIFY VIRTUAL ENVIRONMENT
      - name: Verify virtual environment
        run: |
          echo "üîç VERIFYING VIRTUAL ENVIRONMENT"
          echo "================================"
          
          # Verificar se o venv existe
          if [ ! -d "$VENV_PATH" ]; then
            echo "‚ùå ERROR: Virtual environment not found at: $VENV_PATH"
            echo "This indicates setup-environment failed!"
            exit 1
          fi
          
          # Verificar se Python existe no venv
          if [ ! -f "$VENV_PYTHON" ]; then
            echo "‚ùå ERROR: Python not found in venv: $VENV_PYTHON"
            echo "This indicates setup-environment failed!"
            exit 1
          fi
          
          echo "‚úÖ Virtual environment verified:"
          echo "   Path: $VENV_PATH"
          echo "   Python: $VENV_PYTHON"
          echo "   Version: $($VENV_PYTHON --version)"
          
          # Verificar tamanho do venv
          echo -n "   Size: "
          du -sh "$VENV_PATH" 2>/dev/null || echo "unknown"

      # Step 3: VERIFY DEPENDENCIES IN VENV
      - name: Verify dependencies in venv
        run: |
          echo "üì¶ VERIFYING DEPENDENCIES IN VENV"
          echo "================================"
          
          # Lista de pacotes ESSENCIAIS que DEVERIAM estar no venv
          ESSENTIAL_PACKAGES="Flask flask-sqlalchemy pymysql flask-login setuptools"
          MISSING_PACKAGES=0
          
          echo "Checking essential packages in venv..."
          
          for pkg in $ESSENTIAL_PACKAGES; do
            if $VENV_PIP show "$pkg" >/dev/null 2>&1; then
              version=$($VENV_PIP show "$pkg" | grep "^Version:" | cut -d: -f2 | xargs)
              echo "  ‚úÖ $pkg==$version"
            else
              echo "  ‚ùå $pkg - NOT INSTALLED IN VENV"
              echo "     This indicates setup-environment FAILED!"
              MISSING_PACKAGES=$((MISSING_PACKAGES + 1))
            fi
          done
          
          echo ""
          if [ $MISSING_PACKAGES -gt 0 ]; then
            echo "üíÄ BUILD VERIFICATION FAILED!"
            echo "   $MISSING_PACKAGES essential packages are MISSING from venv"
            echo "   setup-environment should have installed them"
            exit 1
          else
            echo "‚úÖ ALL essential packages are installed in venv"
            echo "‚úÖ Virtual environment is properly configured"
          fi
          
          # Listar todos os pacotes do venv
          echo ""
          echo "üìä All packages in venv:"
          $VENV_PIP list | grep -E "(Flask|Werkzeug|SQLAlchemy|mysql)" || true

      # Step 4: VERIFY FLASK APPLICATION IN VENV
      - name: Verify Flask application in venv
        run: |
          echo "üîç VERIFYING FLASK APPLICATION IN VENV"
          echo "====================================="
          
          # Ir para o diret√≥rio do projeto
          echo "üìÇ Changing to project directory: $PROJECT_ROOT"
          cd "$PROJECT_ROOT"
          echo "Working directory: $(pwd)"
          
          # Verificar estrutura do projeto
          echo ""
          echo "üìÅ Project structure:"
          find . -name "*.py" | head -15 || true
          
          # Executar verifica√ß√£o usando Python do venv
          echo ""
          echo "üß™ Running Flask application verification..."
          
          $VENV_PYTHON << 'EOF'
          import sys
          import os
          
          print("üîß FLASK APPLICATION VERIFICATION")
          print("=" * 40)
          print(f"Python: {sys.executable}")
          print(f"Python version: {sys.version}")
          print(f"Working directory: {os.getcwd()}")
          print(f"Python path: {sys.path[:3]}")
          
          try:
              # Adicionar diret√≥rio atual ao path
              sys.path.insert(0, os.getcwd())
              
              # Importar e criar app
              print("\n1Ô∏è‚É£ Importing Flask application...")
              from app import create_app
              print("‚úÖ Successfully imported create_app from app")
              
              print("\n2Ô∏è‚É£ Creating Flask application...")
              app = create_app('testing')
              print(f"‚úÖ Flask app created: {app.name}")
              
              # Informa√ß√µes do app
              print(f"\nüìã Application info:")
              print(f"   Testing mode: {app.config.get('TESTING', False)}")
              print(f"   Debug mode: {app.config.get('DEBUG', False)}")
              print(f"   Config keys: {len(app.config)}")
              print(f"   Secret key set: {'YES' if app.config.get('SECRET_KEY') else 'NO'}")
              
              # Verificar rotas
              print(f"\nüåê Application routes:")
              routes = list(app.url_map.iter_rules())
              print(f"   Total routes: {len(routes)}")
              
              if routes:
                  for i, route in enumerate(routes[:5]):  # Mostrar primeiras 5 rotas
                      if not route.rule.startswith('/_') and len(route.rule) > 1:
                          methods = ','.join(route.methods)
                          print(f"   {i+1}. {route.rule} [{methods}]")
              
              # Testar cliente
              print("\nüß™ Testing with test client...")
              with app.test_client() as client:
                  # Tentar algumas rotas comuns
                  test_endpoints = ['/', '/login', '/api/health']
                  
                  for endpoint in test_endpoints:
                      try:
                          response = client.get(endpoint)
                          print(f"   {endpoint}: HTTP {response.status_code}")
                      except Exception:
                          print(f"   {endpoint}: Not accessible (might be expected)")
              
              # Verifica√ß√£o final
              print("\n" + "=" * 40)
              print("üéâ APPLICATION VERIFICATION PASSED!")
              print("‚úÖ All imports work")
              print("‚úÖ App can be instantiated")
              print("‚úÖ App structure is valid")
              print("‚úÖ Routes are configured")
              
          except ImportError as e:
              print(f"\n‚ùå IMPORT ERROR: {e}")
              print("This means the app structure has issues!")
              print(f"Current directory: {os.getcwd()}")
              print(f"Looking for: {__file__}")
              sys.exit(1)
          except Exception as e:
              print(f"\n‚ùå APPLICATION ERROR: {type(e).__name__}: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          
          print("\nüöÄ APPLICATION IS READY FOR DEPLOYMENT")
          EOF
          
          echo ""
          echo "‚úÖ Flask application verification completed successfully"