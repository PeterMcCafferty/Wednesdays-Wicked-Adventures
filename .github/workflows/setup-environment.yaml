# ============================================================
# SETUP ENVIRONMENT WORKFLOW
# ============================================================

name: Setup Environment

on:
  workflow_call:
    # ------------------------------------------------------
    # MAIN INPUTS (required)
    # ------------------------------------------------------
    inputs:
      python-version:
        description: "Python version to use (e.g., '3.11', '3.12')"
        required: true
        type: string
        default: "3.11"

      extra-packages:
        description: "Extra packages to install (e.g., 'pytest bandit safety')"
        required: false
        type: string
        default: ""

      force-clean-install:
        description: "Force clean install ignoring cache"
        required: false
        type: string
        default: "false"

    outputs:
      cache-hit:
        description: "Whether dependency cache was hit"
        value: ${{ jobs.setup.outputs.cache-hit }}
      cache-key:
        description: "Cache key for dependencies"
        value: ${{ jobs.setup.outputs.cache-key }}
      requirements-hash:
        description: "Hash of requirements.txt"
        value: ${{ jobs.setup.outputs.requirements-hash }}
      python-version:
        description: "Python version used"
        value: ${{ jobs.setup.outputs.python-version }}
      dependencies-installed:
        description: "Whether dependencies were installed"
        value: ${{ jobs.setup.outputs.dependencies-installed }}
      project-root:
        description: "Project root directory (flask_app/src/main)"
        value: ${{ jobs.setup.outputs.project-root }}
      working-directory:
        description: "Working directory for compatibility"
        value: ${{ jobs.setup.outputs.project-root }}
      workspace-path:
        description: "GitHub workspace path"
        value: ${{ jobs.setup.outputs.workspace-path }}
      app-entrypoint:
        description: "Path to app entry point"
        value: ${{ jobs.setup.outputs.app-entrypoint }}
      venv-path:
        description: "Path to virtual environment"
        value: ${{ jobs.setup.outputs.venv-path }}
      python-path:
        description: "Path to Python executable in venv"
        value: ${{ jobs.setup.outputs.python-path }}

jobs:
  setup:
    name: Setup Python Environment
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    # ------------------------------------------------------
    # OUTPUTS AVAILABLE TO OTHER WORKFLOWS
    # ------------------------------------------------------
    outputs:
      cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}
      cache-key: ${{ steps.generate-cache-key.outputs.cache-key }}
      dependencies-installed: ${{ steps.create-venv-and-install.outputs.deps-installed }}
      python-version: ${{ inputs.python-version }}
      requirements-hash: ${{ steps.generate-cache-key.outputs.requirements-hash }}
      project-root: ${{ steps.configure-paths.outputs.project-root }}
      working-directory: ${{ steps.configure-paths.outputs.project-root }}
      workspace-path: ${{ steps.configure-paths.outputs.workspace-path }}
      app-entrypoint: ${{ steps.configure-paths.outputs.app-entrypoint }}
      venv-path: ${{ steps.create-venv-and-install.outputs.venv-path }}
      python-path: ${{ steps.create-venv-and-install.outputs.python-path }}
    
    steps:  
      # STEP 1: CHECKOUT REPOSITORY
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # STEP 2: SET UP PYTHON
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
      
      # STEP 3: CONFIGURE PROJECT STRUCTURE
      - name: Configure project structure
        id: configure-paths
        run: |
          echo "ðŸ”§ Configuring project structure (same as local)..."
          
          # Paths EXACTLY as you use locally
          WORKSPACE="${{ github.workspace }}"
          PROJECT_ROOT="$WORKSPACE/flask_app/src/main"
          APP_ENTRYPOINT="$PROJECT_ROOT/app/__init__.py"
          REQUIREMENTS_PATH="$WORKSPACE/flask_app/src/requirements.txt"
          
          # Verify if structure exists
          if [ ! -f "$APP_ENTRYPOINT" ]; then
            echo "âŒ ERROR: App entry point not found: $APP_ENTRYPOINT"
            echo "ðŸ“ Directory content:"
            find "$WORKSPACE" -name "*.py" | head -20 || true
            exit 1
          fi
          
          if [ ! -f "$REQUIREMENTS_PATH" ]; then
            echo "âŒ ERROR: requirements.txt not found: $REQUIREMENTS_PATH"
            echo "ðŸ“ Project structure:"
            find "$WORKSPACE" -name "*.txt" | head -20 || true
            exit 1
          fi
          
          # Configure environment variables (as in local)
          echo "PROJECT_ROOT=$PROJECT_ROOT" >> $GITHUB_ENV
          echo "VENV_PATH=$PROJECT_ROOT/venv" >> $GITHUB_ENV
          echo "REQUIREMENTS_PATH=$REQUIREMENTS_PATH" >> $GITHUB_ENV
          
          # Flask variables (for when we activate venv)
          echo "FLASK_APP_PATH=app/__init__.py" >> $GITHUB_ENV  # Relative to PROJECT_ROOT
          echo "FLASK_ENV=testing" >> $GITHUB_ENV
          
          # Export as outputs
          echo "project-root=$PROJECT_ROOT" >> $GITHUB_OUTPUT
          echo "workspace-path=$WORKSPACE" >> $GITHUB_OUTPUT
          echo "app-entrypoint=$APP_ENTRYPOINT" >> $GITHUB_OUTPUT
          
          echo "âœ… Structure configured:"
          echo "   Project root: $PROJECT_ROOT"
          echo "   Venv path: $PROJECT_ROOT/venv"
          echo "   App entrypoint: $APP_ENTRYPOINT"
          echo "   Requirements: $REQUIREMENTS_PATH"
      
      # STEP 4: GENERATE CACHE KEY
      - name: Generate cache key
        id: generate-cache-key
        run: |
          echo "ðŸ”‘ Generating cache key..."
          
          REQ_FILE="$REQUIREMENTS_PATH"
          
          if [ -f "$REQ_FILE" ]; then
            # Hash of dependencies + project structure
            REQ_HASH=$(sha256sum "$REQ_FILE" | cut -d' ' -f1 | head -c 12)
            
            # Specific key for venv
            CACHE_KEY="venv-${{ runner.os }}-python-${{ inputs.python-version }}-deps-${REQ_HASH}"
            
            echo "ðŸ“¦ requirements.txt found:"
            echo "Location: $REQ_FILE"
            echo "Content (first 10 lines):"
            head -10 "$REQ_FILE" || true
            echo ""
            echo "Hash: ${REQ_HASH}"
            echo "Cache key: ${CACHE_KEY}"
            
            echo "cache-key=${CACHE_KEY}" >> $GITHUB_OUTPUT
            echo "requirements-hash=${REQ_HASH}" >> $GITHUB_OUTPUT
          else
            echo "âŒ ERROR: requirements.txt not found at $REQ_FILE"
            exit 1
          fi
      
      # STEP 5: CACHE VIRTUAL ENVIRONMENT
      - name: Cache virtual environment
        id: cache-deps
        uses: actions/cache@v4
        with:
          # Cache the ENTIRE VENV (same as local)
          path: |
            ${{ env.VENV_PATH }}
            ~/.cache/pip
          key: ${{ steps.generate-cache-key.outputs.cache-key }}
          restore-keys: |
            venv-${{ runner.os }}-python-${{ inputs.python-version }}-deps-
            venv-${{ runner.os }}-python-${{ inputs.python-version }}-
      
      # STEP 6: CREATE VENV AND INSTALL (EXACTLY AS YOU DO LOCALLY)
      - name: Create venv and install dependencies
        id: create-venv-and-install
        env:
          FORCE_CLEAN: ${{ inputs.force-clean-install }}
          EXTRA_PKGS: ${{ inputs.extra-packages }}
          WORKSPACE: ${{ github.workspace }}
          REQUIREMENTS_PATH: ${{ github.workspace }}/flask_app/src/requirements.txt
          PROJECT_ROOT: ${{ github.workspace }}/flask_app/src/main
        run: |
          echo "ðŸš€ REPLICATING LOCAL SETUP"
          echo "========================="
          
          # 1. Go to main directory (as you do)
          echo "ðŸ“‚ Going to: $PROJECT_ROOT"
          cd "$PROJECT_ROOT"
          echo "ðŸ“ Current directory: $(pwd)"
          echo "ðŸ“ Content:"
          ls -la || true
          
          # Check if venv already exists from cache
          if [ -d "venv" ] && [ "${{ steps.cache-deps.outputs.cache-hit }}" == 'true' ] && [ "$FORCE_CLEAN" == 'false' ]; then
            echo "âœ… Venv found in cache"
            echo "ðŸ“ Venv content:"
            ls -la venv/bin/python* 2>/dev/null || echo "   (venv empty or not initialized)"
          else
            # 2. Create venv (python3 -m venv venv) - USING python3!
            echo "ðŸ Creating venv..."
            python3 -m venv venv
            echo "âœ… Venv created at: $(pwd)/venv"
          fi
          
          # 3. Activate venv (source venv/bin/activate)
          echo "ðŸ”“ Activating venv..."
          source venv/bin/activate
          
          # Verify we're in the venv
          echo ""
          echo "ðŸ§ª Venv verification:"
          echo "   Python executable: $(which python)"
          echo "   Python version: $(python --version)"
          echo "   Pip executable: $(which pip)"
          
          # 4. Update pip inside venv - USING python3!
          echo "â¬†ï¸ Upgrading pip..."
          python3 -m pip install --upgrade pip
          
          # 5. Install requirements.txt (ONE LEVEL UP!)
          echo "ðŸ“¦ Installing requirements.txt..."
          echo "ðŸ“ Requirements path: $REQUIREMENTS_PATH"
          
          if [ -f "$REQUIREMENTS_PATH" ]; then
            echo "âœ… Found requirements.txt"
            echo "ðŸ“‹ requirements.txt content:"
            cat "$REQUIREMENTS_PATH"
            echo ""
            
            pip install -r "$REQUIREMENTS_PATH"
            echo "âœ… Requirements installed"
          else
            echo "âŒ ERROR: requirements.txt not found at $REQUIREMENTS_PATH"
            echo "ðŸ“ Searching for requirements.txt files:"
            find "$WORKSPACE" -name "requirements.txt" 2>/dev/null || true
            exit 1
          fi
          
          # 6. Install extra packages if specified
          if [ -n "$EXTRA_PKGS" ]; then
            echo "âž• Extra packages: $EXTRA_PKGS"
            pip install $EXTRA_PKGS
          fi
          
          # 7. Verify installation (as you would locally)
          echo ""
          echo "ðŸ” Installation verification:"
          echo "ðŸ“¦ Flask packages installed:"
          pip list | grep -i flask || echo "   (no flask packages found)"
          echo ""
          
          # 8. Test if app can be imported (pre-test of flask run)
          echo "ðŸ§ª Testing Flask app import..."
          python -c "
          import sys
          import os
          print(f'ðŸ“ Current directory: {os.getcwd()}')
          print(f'ðŸ Python path: {sys.path[:3]}...')
          try:
              # Add current directory to path
              sys.path.insert(0, '.')
              from app import create_app
              app = create_app()
              print(f'âœ… Flask app loaded: {app.name}')
              print(f'   Mode: {app.config.get(\"ENV\", \"unknown\")}')
              print(f'   Debug: {app.config.get(\"DEBUG\", False)}')
              print(f'   Secret Key configured: {\"yes\" if app.config.get(\"SECRET_KEY\") else \"no\"}')
          except ImportError as e:
              print(f'âŒ Import error: {e}')
              print(f'   Full path: {sys.path}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          except Exception as e:
              print(f'âš ï¸  Error creating app: {e}')
              import traceback
              traceback.print_exc()
          "
          
          # Save outputs
          echo "venv-path=$PROJECT_ROOT/venv" >> $GITHUB_OUTPUT
          echo "python-path=$PROJECT_ROOT/venv/bin/python" >> $GITHUB_OUTPUT
          echo "deps-installed=true" >> $GITHUB_OUTPUT
          
          echo ""
          echo "ðŸŽ‰ SETUP COMPLETE WITH VENV!"
          echo "ðŸ“‹ SUMMARY:"
          echo "   Directory: $PROJECT_ROOT"
          echo "   Venv: $PROJECT_ROOT/venv"
          echo "   Requirements: $REQUIREMENTS_PATH"
          echo "   Cache hit: ${{ steps.cache-deps.outputs.cache-hit }}"
          echo ""
          echo "ðŸ’¡ To run the app (as locally):"
          echo "   1. cd $PROJECT_ROOT"
          echo "   2. source venv/bin/activate"
          echo "   3. flask run"
          echo ""
          echo "âš¡ To test now in pipeline:"
          echo "   source venv/bin/activate && flask --app app/__init__.py --debug run &"
      
      # STEP 7: FINAL VERIFICATION AND ARTIFACT
      - name: Final verification and artifact
        if: always()
        env:
          PROJECT_ROOT: ${{ github.workspace }}/flask_app/src/main
          VENV_PATH: ${{ github.workspace }}/flask_app/src/main/venv
        run: |
          echo "ðŸ“Š FINAL SETUP VERIFICATION"
          echo "============================="
          
          # Check if venv is working
          if [ -d "$VENV_PATH" ]; then
            echo "âœ… Venv found at: $VENV_PATH"
            echo "ðŸ“ Venv size:"
            du -sh "$VENV_PATH" 2>/dev/null || echo "   (could not calculate)"
          else
            echo "âš ï¸  Venv not found at: $VENV_PATH"
          fi
          
          # Create configuration file for next workflows
          echo "ðŸ“„ Creating environment configuration file..."
          cat > "$PROJECT_ROOT/venv/.pipeline_env" << EOF
          # Environment configuration - CI/CD Pipeline
          # Generated automatically at: $(date)
          
          PROJECT_ROOT=$PROJECT_ROOT
          VENV_PATH=$VENV_PATH
          PYTHON_PATH=$VENV_PATH/bin/python
          PIP_PATH=$VENV_PATH/bin/pip
          FLASK_APP=app/__init__.py
          FLASK_ENV=testing
          PYTHON_VERSION=${{ inputs.python-version }}
          REQUIREMENTS_HASH=${{ steps.generate-cache-key.outputs.requirements-hash }}
          CACHE_HIT=${{ steps.cache-deps.outputs.cache-hit }}
          
          # Useful commands:
          # source \$VENV_PATH/bin/activate
          # flask --app \$FLASK_APP run
          # python -m pytest tests/
          EOF
          
          echo "ðŸ“‹ Environment file content:"
          cat "$PROJECT_ROOT/venv/.pipeline_env"
          
          echo ""
          echo "âœ… SETUP-ENVIRONMENT COMPLETED SUCCESSFULLY"
          echo "ðŸ“¤ Outputs available for next jobs:"
          echo "   project-root: $PROJECT_ROOT"
          echo "   venv-path: $VENV_PATH"
          echo "   requirements-hash: ${{ steps.generate-cache-key.outputs.requirements-hash }}"
          echo "   cache-hit: ${{ steps.cache-deps.outputs.cache-hit }}"