# ============================================================
# PIPELINE ORCHESTRATOR
# ============================================================
name: Pipeline Orchestrator

on:
  push:
    branches: [UAT, feature/*]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # FASE 0: SMOKE TESTS (FAST CHECKS)
    smoke-tests:
      uses: ./.github/workflows/smoke-test.yaml
      with:
        python-version: "3.11"
      working-directory: "flask_app/src"
      
  # 1. Security Scan
  security-sast:
    uses: ./.github/workflows/sast.yaml
    with:
      python-version: "3.11"
      working-directory: "flask_app/src"
      fail-on-issues: false  # For testing, we won't fail

  # 2. Build Application
  build-app:
    uses: ./.github/workflows/build-app.yaml
    needs: [smoke-test, security-sast]
    with:
      python-version: "3.11"
      working-directory: "flask_app/src"

  # 3. Test REAL Application
  test-app:
    uses: ./.github/workflows/test-app.yaml
    needs: [build-app]
    with:
      python-version: "3.11"
      working-directory: "flask_app/src"

  # 4. Pipeline Summary
  pipeline-summary:
    runs-on: ubuntu-latest
    needs: [smoke-test, security-sast, build-app, test-app]
    if: always()
    timeout-minutes: 2
    
    steps:
      - name: Pipeline Status Report
        run: |
          echo "üöÄ CI/CD PIPELINE COMPLETED"
          echo "==========================="
          echo ""
          echo "Job Results:"
          echo "------------"
          echo "Smoke Test......: ${{ needs.smoke-test.result }}"
          echo "Security Scan...: ${{ needs.security-sast.result }}"
          echo "Build...........: ${{ needs.build-app.result }}"
          echo "Tests...........: ${{ needs.test-app.result }}"
          echo ""
          
          # Determine overall status
          if [[ "${{ needs.smoke-test.result }}" == "success" && 
                "${{ needs.build-app.result }}" == "success" && 
                "${{ needs.test-app.result }}" == "success" ]]; then
            echo "‚úÖ ALL CRITICAL JOBS PASSED!"
            echo "‚úÖ Application is ready for deployment"
          else
            echo "‚ö†Ô∏è  Some jobs failed or were skipped"
            echo "Review individual job logs for details"
          fi
          
          echo ""
          echo "Pipeline execution complete."