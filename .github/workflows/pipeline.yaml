# ============================================================
# PIPELINE
# ============================================================
name: CI/CD Pipeline 

on:
  push:
    branches: [UAT, feature/*]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  ci-pipeline:
    name: CI/CD Pipeline
    runs-on: ubuntu-latest
    timeout-minutes: 15 
    
    steps:
      # ======================================================
      # STEP 0: CHECKOUT CODE
      # ======================================================
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # ======================================================
      # STEP 1: SETUP PYTHON
      # ======================================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      # ======================================================
      # PHASE 0: SETUP ENVIRONMENT (EXACTLY AS LOCAL)
      # ======================================================
      - name: Setup Virtual Environment
        id: setup-phase
        run: |
          echo "üöÄ PHASE 0: SETUP ENVIRONMENT"
          echo "============================="
          echo ""
          echo "üìÇ Going to: flask_app/src/main"
          cd flask_app/src/main
          echo "üìç Current directory: $(pwd)"
          echo ""
          
          # 1. Create venv (exactly as you do locally)
          echo "üêç Creating virtual environment..."
          python3 -m venv venv
          echo "‚úÖ Venv created at: $(pwd)/venv"
          echo ""
          
          # 2. Activate venv
          echo "üîì Activating venv..."
          source venv/bin/activate
          echo "‚úÖ Venv activated"
          echo "   Python: $(which python)"
          echo "   Version: $(python --version)"
          echo ""
          
          # 3. Update pip
          echo "‚¨ÜÔ∏è Upgrading pip..."
          python -m pip install --upgrade pip
          echo ""
          
          # 4. Install requirements (one level up)
          echo "üì¶ Installing requirements.txt..."
          echo "üìç From: ../requirements.txt"
          pip install -r ../requirements.txt
          echo "‚úÖ Requirements installed"
          echo ""
          
          # 5. Install extra packages (pytest is already in requirements)
          echo "‚ûï Checking pytest..."
          if ! pip show pytest >/dev/null 2>&1; then
            echo "Installing pytest..."
            pip install pytest
          fi
          echo "‚úÖ Pytest available"
          echo ""
          
          # 6. Basic verification only
          echo "üîç Basic verification..."
          pip show Flask pytest | grep -E "^(Name|Version):" || true
          echo ""
          
          echo "üéâ SETUP COMPLETED SUCCESSFULLY"
      
      # ======================================================
      # PHASE 1: SECURITY SCAN (SAST) - BANDIT
      # ======================================================
      - name: Security Scan (SAST)
        id: security-phase
        run: |
          echo "üîç PHASE 1: SECURITY SCAN"
          echo "========================="
          echo ""
          
          # 1. Activate venv and go to project
          echo "üìÇ Activating venv..."
          cd flask_app/src/main
          source venv/bin/activate
          echo "üìç Directory: $(pwd)"
          echo ""
          
          # 2. Install bandit if needed
          echo "üì¶ Checking bandit..."
          if ! pip show bandit >/dev/null 2>&1; then
            echo "Installing bandit..."
            pip install bandit
          fi
          echo "‚úÖ Bandit available"
          echo ""
          
          # 3. Run quick scan (optional - can skip if you want)
          echo "üîç Running quick security scan..."
          bandit -r . -f json -o bandit-results.json || echo "‚ö†Ô∏è Scan failed, continuing..."
          
          if [ -f "bandit-results.json" ]; then
            echo "üìä Scan result saved in bandit-results.json"
          fi
          echo ""
          echo "‚úÖ SECURITY PHASE COMPLETED"
      
      # ======================================================
      # PHASE 2: RUN TESTS WITH pytest
      # ======================================================
      - name: Run Tests with pytest
        id: test-phase
        run: |
          echo "üß™ PHASE 2: RUN TESTS"
          echo "====================="
          echo ""
          
          # 1. Activate venv and go to project
          echo "üìÇ Activating venv..."
          cd flask_app/src/main
          source venv/bin/activate
          echo "üìç Directory: $(pwd)"
          echo "üêç Python: $(which python)"
          echo ""
          
          # 2. Check test structure
          echo "üìÅ Test structure:"
          find . -name "*test*.py" -type f | head -10 || echo "No tests found"
          echo ""
          
          # 3. Run pytest
          echo "üöÄ Running pytest..."
          python -m pytest tests/ -v --cov=app --cov-report=term-missing
          
          echo ""
          echo "‚úÖ TESTS EXECUTED SUCCESSFULLY"
      
      # ======================================================
      # PHASE 3: PIPELINE SUMMARY
      # ======================================================
      - name: Pipeline Summary
        if: always()
        run: |
          echo "üìä PHASE 3: PIPELINE SUMMARY"
          echo "============================"
          echo ""
          echo "Results:"
          echo "--------"
          echo "Setup Environment....: ${{ steps.setup-phase.conclusion || 'unknown' }}"
          echo "Security Scan........: ${{ steps.security-phase.conclusion || 'unknown' }}"
          echo "Test Execution.......: ${{ steps.test-phase.conclusion || 'unknown' }}"
          echo ""
          echo "Overall Status.......: ${{ job.status }}"
          echo ""
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ PIPELINE COMPLETED SUCCESSFULLY!"
            echo "‚úÖ Environment configured correctly"
            echo "‚úÖ Tests executed"
            echo "‚úÖ Ready for next steps"
          else
            echo "‚ö†Ô∏è Some phases failed"
            echo "Check logs for details"
          fi
          
          echo ""
          echo "========================================"
          echo "üöÄ PIPELINE EXECUTION COMPLETE"
          echo "========================================"