steps:
  # ======================================================
  # STEP 0: CHECKOUT CODE
  # ======================================================
  - name: Checkout repository
    uses: actions/checkout@v4
  
  # ======================================================
  # STEP 1: SETUP PYTHON
  # ======================================================
  - name: Setup Python
    uses: actions/setup-python@v5
    with:
      python-version: "3.11"
  
  # ======================================================
  # PHASE 0: SETUP ENVIRONMENT (EXACTLY AS LOCAL)
  # ======================================================
  - name: Setup Virtual Environment
    id: setup-phase
    run: |
      echo "üöÄ PHASE 0: SETUP ENVIRONMENT"
      echo "============================="
      echo ""
      echo "üìÇ Going to project directory: flask_app/src/main"
      cd flask_app/src/main
      echo "üìç Current directory: $(pwd)"
      echo ""
      
      # 1. Create venv (exactly as you do locally)
      echo "üêç Creating virtual environment..."
      python3 -m venv venv
      echo "‚úÖ Venv created at: $(pwd)/venv"
      echo ""
      
      # 2. Activate venv
      echo "üîì Activating venv..."
      source venv/bin/activate
      echo "‚úÖ Venv activated"
      echo "   Python: $(which python)"
      echo "   Version: $(python --version)"
      echo ""
      
      # 3. Update pip
      echo "‚¨ÜÔ∏è Upgrading pip..."
      python -m pip install --upgrade pip
      echo ""
      
      # 4. Install requirements (one level up)
      echo "üì¶ Installing requirements.txt..."
      echo "üìç From: ../requirements.txt"
      pip install -r ../requirements.txt
      echo "‚úÖ Requirements installed"
      echo ""
      
      # 5. Install extra packages (pytest, bandit)
      echo "‚ûï Installing extra packages: pytest bandit"
      pip install pytest bandit
      echo "‚úÖ Extra packages installed"
      echo ""
      
      # 6. Verify installation
      echo "üîç Verifying installation..."
      echo "üì¶ Key packages:"
      pip show Flask flask-sqlalchemy pymysql flask-login pytest bandit | grep -E "^(Name|Version):" || true
      echo ""
      
      # 7. Test Flask app import
      echo "üß™ Testing Flask app import..."
      python -c "
      import sys
      print(f'Python path: {sys.executable}')
      try:
          from app import create_app
          app = create_app()
          print(f'‚úÖ App loaded: {app.name}')
          print(f'   Debug mode: {app.config.get(\"DEBUG\", False)}')
          print(f'   Secret key: {\"SET\" if app.config.get(\"SECRET_KEY\") else \"NOT SET\"}')
      except Exception as e:
          print(f'‚ùå Error: {e}')
          import traceback
          traceback.print_exc()
          sys.exit(1)
      "
      echo ""
      echo "üéâ SETUP PHASE COMPLETED SUCCESSFULLY"
  
  # ======================================================
  # PHASE 1: SECURITY SCAN (SAST)
  # ======================================================
  - name: Security Scan (SAST)
    id: security-phase
    run: |
      echo "üîç PHASE 1: SECURITY SCAN"
      echo "========================="
      echo ""
      
      # 1. Activate venv and go to project
      echo "üìÇ Activating venv and going to project..."
      cd flask_app/src/main
      source venv/bin/activate
      echo "üìç Directory: $(pwd)"
      echo "üêç Python: $(which python)"
      echo ""
      
      # 2. Run Bandit scan
      echo "üîç Running Bandit security scan..."
      bandit -r . -f json -o bandit-results.json
      echo "‚úÖ Security scan completed"
      echo ""
      
      # 3. Analyze results
      echo "üìä Security Scan Results:"
      if [ -f "bandit-results.json" ]; then
        # Install jq if needed
        if ! command -v jq &> /dev/null; then
          sudo apt-get update && sudo apt-get install -y jq
        fi
        
        HIGH=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-results.json 2>/dev/null || echo "0")
        MEDIUM=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' bandit-results.json 2>/dev/null || echo "0")
        LOW=$(jq '[.results[] | select(.issue_severity == "LOW")] | length' bandit-results.json 2>/dev/null || echo "0")
        
        echo "   HIGH severity issues: $HIGH"
        echo "   MEDIUM severity issues: $MEDIUM"
        echo "   LOW severity issues: $LOW"
        echo ""
        
        if [ "$HIGH" -gt 0 ] || [ "$MEDIUM" -gt 0 ]; then
          echo "‚ö†Ô∏è Found security issues (continuing pipeline)"
          echo "   Summary of issues:"
          jq -r '.results[] | "    \(.issue_severity): \(.issue_text) (in \(.filename):\(.line_number))"' bandit-results.json 2>/dev/null | head -5 || true
        else
          echo "‚úÖ No HIGH or MEDIUM severity issues found"
        fi
      else
        echo "‚ö†Ô∏è No results file generated"
      fi
      echo ""
      echo "üéâ SECURITY PHASE COMPLETED"
  
  # ======================================================
  # PHASE 2: BUILD VERIFICATION
  # ======================================================
  - name: Build Verification
    id: build-phase
    run: |
      echo "üèóÔ∏è PHASE 2: BUILD VERIFICATION"
      echo "=============================="
      echo ""
      
      # 1. Activate venv and go to project
      echo "üìÇ Activating venv and going to project..."
      cd flask_app/src/main
      source venv/bin/activate
      echo "üìç Directory: $(pwd)"
      echo "üêç Python: $(which python)"
      echo ""
      
      # 2. Verify essential dependencies are installed
      echo "üì¶ Verifying essential dependencies..."
      ESSENTIAL_PACKAGES="Flask flask-sqlalchemy pymysql flask-login"
      ALL_INSTALLED=true
      
      for pkg in $ESSENTIAL_PACKAGES; do
        if pip show "$pkg" >/dev/null 2>&1; then
          version=$(pip show "$pkg" | grep "^Version:" | cut -d: -f2 | xargs)
          echo "  ‚úÖ $pkg==$version"
        else
          echo "  ‚ùå $pkg - NOT INSTALLED"
          ALL_INSTALLED=false
        fi
      done
      
      if [ "$ALL_INSTALLED" = false ]; then
        echo "üíÄ BUILD FAILED: Missing essential dependencies"
        exit 1
      fi
      echo "‚úÖ All essential dependencies verified"
      echo ""
      
      # 3. Comprehensive Flask app test
      echo "üß™ Comprehensive Flask application test..."
      python << 'EOF'
      import sys
      import os
      
      print("üîß FLASK APPLICATION TEST")
      print("=" * 40)
      
      try:
          # Test imports
          print("1. Testing imports...")
          from app import create_app
          print("   ‚úÖ Import successful")
          
          # Create app
          print("\n2. Creating application...")
          app = create_app('testing')
          print(f"   ‚úÖ App created: {app.name}")
          
          # Config verification
          print("\n3. Configuration verification:")
          print(f"   Testing mode: {app.config.get('TESTING', False)}")
          print(f"   Debug mode: {app.config.get('DEBUG', False)}")
          print(f"   Secret key configured: {'YES' if app.config.get('SECRET_KEY') else 'NO'}")
          
          # Routes verification
          print("\n4. Routes verification:")
          routes = list(app.url_map.iter_rules())
          print(f"   Total routes found: {len(routes)}")
          
          if routes:
              print("   Sample routes:")
              count = 0
              for route in routes:
                  if not route.rule.startswith('/_') and len(route.rule) > 1:
                      methods = ','.join(route.methods)
                      print(f"     - {route.rule} [{methods}]")
                      count += 1
                      if count >= 3:
                          break
          
          # Test client
          print("\n5. Test client verification:")
          with app.test_client() as client:
              test_endpoints = ['/', '/login']
              for endpoint in test_endpoints:
                  try:
                      response = client.get(endpoint)
                      print(f"   {endpoint}: HTTP {response.status_code}")
                  except Exception:
                      print(f"   {endpoint}: Not accessible (may be expected)")
          
          print("\n" + "=" * 40)
          print("üéâ APPLICATION BUILD VERIFIED!")
          print("‚úÖ All imports work")
          print("‚úÖ App can be instantiated")
          print("‚úÖ Configuration is valid")
          print("‚úÖ Routes are accessible")
          
      except ImportError as e:
          print(f"\n‚ùå IMPORT ERROR: {e}")
          sys.exit(1)
      except Exception as e:
          print(f"\n‚ùå APPLICATION ERROR: {type(e).__name__}: {e}")
          import traceback
          traceback.print_exc()
          sys.exit(1)
      
      print("\nüöÄ APPLICATION IS READY FOR DEPLOYMENT")
      EOF
      echo ""
      echo "üéâ BUILD PHASE COMPLETED SUCCESSFULLY"
  
  # ======================================================
  # PHASE 3: PIPELINE SUMMARY
  # ======================================================
  - name: Pipeline Summary
    if: always()
    run: |
      echo "üìä PHASE 3: PIPELINE SUMMARY"
      echo "============================"
      echo ""
      echo "Pipeline Results:"
      echo "----------------"
      echo "Setup Phase........: ${{ steps.setup-phase.conclusion || 'unknown' }}"
      echo "Security Phase.....: ${{ steps.security-phase.conclusion || 'unknown' }}"
      echo "Build Phase........: ${{ steps.build-phase.conclusion || 'unknown' }}"
      echo ""
      echo "Overall Status.....: ${{ job.status }}"
      echo ""
      
      if [ "${{ job.status }}" = "success" ]; then
        echo "‚úÖ ALL PIPELINE PHASES PASSED!"
        echo "‚úÖ Application is ready for deployment"
        echo "‚úÖ Single venv used throughout"
        echo "‚úÖ No cache/complexity issues"
      else
        echo "‚ö†Ô∏è Some pipeline phases failed"
        echo "Review individual step logs for details"
      fi
      
      echo ""
      echo "========================================"
      echo "üöÄ CI/CD PIPELINE EXECUTION COMPLETE"
      echo "========================================"