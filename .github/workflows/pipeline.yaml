# ============================================================
# PIPELINE ORCHESTRATOR
# ============================================================
name: Pipeline Orchestrator

on:
  push:
    branches: [UAT, feature/*]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # PHASE 0: SETUP ENVIRONMENT (INSTALL DEPENDENCIES ONCE)
  setup-environment:
    uses: ./.github/workflows/setup-environment.yaml
    with:
      python-version: "3.11"
      # Install extra packages needed by all workflows
      extra-packages: "pytest bandit"
      force-clean-install: "false"

  # PHASE 1: SECURITY SCAN WITH SAST
  security-sast:
    uses: ./.github/workflows/sast.yaml
    needs: setup-environment
    with:
      project-root: ${{ needs.setup-environment.outputs.project-root }}
      venv-path: ${{ needs.setup-environment.outputs.venv-path }}
      python-path: ${{ needs.setup-environment.outputs.python-path }}
      requirements-hash: ${{ needs.setup-environment.outputs.requirements-hash }}
      python-version: ${{ needs.setup-environment.outputs.python-version }}
      fail-on-issues: "false"

  # PHASE 2: BUILD APPLICATION
  build-app:
    uses: ./.github/workflows/build-app.yaml
    needs: [setup-environment, security-sast] 
    with:
      project-root: ${{ needs.setup-environment.outputs.project-root }}
      venv-path: ${{ needs.setup-environment.outputs.venv-path }}
      python-path: ${{ needs.setup-environment.outputs.python-path }}
      requirements-hash: ${{ needs.setup-environment.outputs.requirements-hash }}
      python-version: ${{ needs.setup-environment.outputs.python-version }}

  # PHASE 3: PIPELINE SUMMARY
  pipeline-summary:
    runs-on: ubuntu-latest
    needs: [setup-environment, security-sast, build-app] 
    if: always()
    timeout-minutes: 2
    
    steps:
      - name: Pipeline Status Report
        run: |
          echo "üöÄ CI/CD PIPELINE COMPLETED"
          echo "==========================="
          echo ""
          echo "Job Results:"
          echo "------------"
          echo "Setup Environment.: ${{ needs.setup-environment.result }}"
          echo "Security Scan.....: ${{ needs.security-sast.result }}"
          echo "Build.............: ${{ needs.build-app.result }}"
          echo ""
          echo "Cache Status......: ${{ needs.setup-environment.outputs.cache-hit }}"
          echo "Requirements Hash.: ${{ needs.setup-environment.outputs.requirements-hash }}"
          echo "Deps Installed....: ${{ needs.setup-environment.outputs.dependencies-installed }}"
          echo "Project Root......: ${{ needs.setup-environment.outputs.project-root }}"
          echo ""
          
          # Determine overall status
          if [[ "${{ needs.security-sast.result }}" == "success" &&
                "${{ needs.build-app.result }}" == "success" ]]; then
            echo "‚úÖ ALL CRITICAL JOBS PASSED!"
            echo "‚úÖ Application is ready for deployment"
          else
            echo "‚ö†Ô∏è  Some jobs failed or were skipped"
            echo "Review individual job logs for details"
          fi
          
          echo ""
          echo "Pipeline execution complete."