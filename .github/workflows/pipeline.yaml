# ============================================================
# PIPELINE ORCHESTRATOR
# ============================================================
name: Pipeline Orchestrator

on:
  push:
    branches: [UAT, feature/*]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # PHASE 0: SETUP ENVIRONMENT (INSTALL DEPENDENCIES ONCE)
  setup-environment:
    uses: ./.github/workflows/setup-environment.yaml
    with:
      python-version: "3.11"
      # Install extra packages needed by all workflows
      extra-packages: "pytest bandit"

  # PHASE 1: SMOKE TEST (FAST CHECK - 2-3 minutes)
  smoke-test:
    uses: ./.github/workflows/smoke-test.yaml
    needs: setup-environment
    with:
      python-version: ${{ needs.setup-environment.outputs.python-version }}
      working-directory: "flask_app/src/main"
      dependencies-installed: true  # Indicates dependencies are already installed
      cache-key: ${{ needs.setup-environment.outputs.cache-key }}
      requirements-hash: ${{ needs.setup-environment.outputs.requirements-hash }}

  # PHASE 2: SECURITY SCAN (parallel)
  security-sast:
    uses: ./.github/workflows/sast.yaml
    needs: setup-environment
    with:
      python-version: ${{ needs.setup-environment.outputs.python-version }}
      working-directory: "flask_app/src"
      fail-on-issues: false  # For testing, we won't fail
      dependencies-installed: true  # Indicates dependencies are already installed
      cache-key: ${{ needs.setup-environment.outputs.cache-key }}

  # PHASE 3: BUILD APPLICATION
  build-app:
    uses: ./.github/workflows/build-app.yaml
    needs: [smoke-test, security-sast]
    with:
      python-version: ${{ needs.setup-environment.outputs.python-version }}
      working-directory: "flask_app/src"
      dependencies-installed: true  # Indicates dependencies are already installed
      cache-key: ${{ needs.setup-environment.outputs.cache-key }}

  # PHASE 4: TEST REAL APPLICATION
  test-app:
    uses: ./.github/workflows/test-app.yaml
    needs: [build-app]
    with:
      python-version: ${{ needs.setup-environment.outputs.python-version }}
      working-directory: "flask_app/src"
      dependencies-installed: true  # Indicates dependencies are already installed
      cache-key: ${{ needs.setup-environment.outputs.cache-key }}

  # PHASE 5: PIPELINE SUMMARY
  pipeline-summary:
    runs-on: ubuntu-latest
    needs: [setup-environment, smoke-test, security-sast, build-app, test-app]
    if: always()
    timeout-minutes: 2
    
    steps:
      - name: Pipeline Status Report
        run: |
          echo "üöÄ CI/CD PIPELINE COMPLETED"
          echo "==========================="
          echo ""
          echo "Job Results:"
          echo "------------"
          echo "Setup Environment.: ${{ needs.setup-environment.result }}"
          echo "Smoke Test........: ${{ needs.smoke-test.result }}"
          echo "Security Scan.....: ${{ needs.security-sast.result }}"
          echo "Build.............: ${{ needs.build-app.result }}"
          echo "Tests.............: ${{ needs.test-app.result }}"
          echo ""
          echo "Cache Status......: ${{ needs.setup-environment.outputs.cache-hit }}"
          echo "Requirements Hash.: ${{ needs.setup-environment.outputs.requirements-hash }}"
          echo ""
          
          # Determine overall status
          if [[ "${{ needs.smoke-test.result }}" == "success" && 
                "${{ needs.build-app.result }}" == "success" && 
                "${{ needs.test-app.result }}" == "success" ]]; then
            echo "‚úÖ ALL CRITICAL JOBS PASSED!"
            echo "‚úÖ Application is ready for deployment"
          else
            echo "‚ö†Ô∏è  Some jobs failed or were skipped"
            echo "Review individual job logs for details"
          fi
          
          echo ""
          echo "Pipeline execution complete."