# ============================================================
# SAMPLE TEST WORKFLOW TEMPLATE 
#
# PURPOSE
# -------
# This workflow is a TEMPLATE and CONTRACT for creating new
# test workflows in this repository.
#
# How to use:
# 1. Copy this file
# 2. Rename it to: test-<your-test-name>.yaml
# 3. Replace the example steps with your real test logic
#
# IMPORTANT RULES
# ---------------
# - DO NOT add triggers like push or pull_request
# - This workflow MUST be invoked only by pipeline.yaml
# - Use workflow_call and follow the input contract
# - Keep ONE job per test workflow
# - MUST depend on setup-environment in pipeline.yaml
# ============================================================

name: Sample Test Template

on:
  workflow_call:
    inputs:
      # ------------------------------------------------------
      # STANDARD INPUTS (REQUIRED FOR ALL TEST WORKFLOWS)
      # ------------------------------------------------------
      python-version:
        description: "Python version to use for this test"
        required: true
        type: string

      working-directory:
        description: "Directory where the project or test should run"
        required: true
        type: string

      dependencies-installed:
        description: "Must be true - indicates dependencies are installed from setup-environment"
        required: true
        type: boolean
        default: false

      cache-key:
        description: "Cache key from setup-environment for dependency cache"
        required: true
        type: string

      # ------------------------------------------------------
      # TEST-SPECIFIC INPUTS (CUSTOMIZE AS NEEDED)
      # ------------------------------------------------------
      fail-on-issues:
        description: "If true, the test must fail the pipeline on issues"
        required: false
        type: boolean
        default: true

      config-file:
        description: "Optional configuration file for the test tool"
        required: false
        type: string
        default: ""

      scan-path:
        description: "Optional path to scan or test"
        required: false
        type: string
        default: "."

      test-dependencies:
        description: "Extra test dependencies to install (space-separated)"
        required: false
        type: string
        default: ""

jobs:
  sample-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # ------------------------------------------------------
      # Step 1: Checkout repository
      # ------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ------------------------------------------------------
      # Step 2: Set up Python
      # ------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      # ------------------------------------------------------
      # Step 3: Restore Python dependencies cache
      # ------------------------------------------------------
      - name: Restore Python dependencies cache
        if: ${{ inputs.dependencies-installed && inputs.cache-key != '' }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            /opt/hostedtoolcache/Python
          key: ${{ inputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-python-${{ inputs.python-version }}-deps-

      # ------------------------------------------------------
      # Step 4: Verify setup-environment was executed
      # ------------------------------------------------------
      - name: Verify setup-environment was executed
        if: ${{ !inputs.dependencies-installed || inputs.cache-key == '' }}
        run: |
          echo "‚ùå ERROR: This test workflow requires setup-environment to run first"
          echo "Please run via pipeline.yaml with:"
          echo "  - dependencies-installed: true"
          echo "  - cache-key: \${{ needs.setup-environment.outputs.cache-key }}"
          exit 1

      # ------------------------------------------------------
      # Step 5: Install test-specific dependencies (optional)
      # ------------------------------------------------------
      - name: Install test-specific dependencies
        if: ${{ inputs.test-dependencies != '' }}
        working-directory: ${{ inputs.working-directory }}
        run: |
          echo "üì¶ Installing test-specific dependencies..."
          echo "Extra dependencies: ${{ inputs.test-dependencies }}"
          
          python -m pip install --upgrade pip
          pip install ${{ inputs.test-dependencies }}

      # ------------------------------------------------------
      # Step 6: Run the test (REPLACE THIS WITH YOUR ACTUAL TEST)
      # ------------------------------------------------------
      - name: Run test
        working-directory: ${{ inputs.working-directory }}
        env:
          TEST_CONFIG: ${{ inputs.config-file }}
          SCAN_PATH: ${{ inputs.scan-path }}
        run: |
          echo "üß™ Running test..."
          echo "Using dependencies from: setup-environment"
          echo "Config file: ${TEST_CONFIG}"
          echo "Scan path: ${SCAN_PATH}"
          
          # EXAMPLE: Running pytest tests
          # Replace this with your actual test command
          if [ -d "tests" ]; then
            echo "Running pytest tests..."
            python -m pytest ${SCAN_PATH} -v --tb=short --cov=. --cov-report=xml
          else
            echo "‚ö†Ô∏è No tests directory found"
            echo "Creating a minimal test example..."
            
            # Minimal test example
            python3 << 'EOF'
            import sys
            
            print("Sample test - replace with your actual tests")
            print(f"Python version: {sys.version}")
            
            # Example test logic
            try:
                import flask
                print(f"‚úÖ Flask imported: {flask.__version__}")
            except ImportError:
                print("‚ùå Flask not found")
                sys.exit(1)
            
            print("‚úÖ Test completed successfully")
            EOF
          fi

      # ------------------------------------------------------
      # Step 7: Enforce failure policy
      # ------------------------------------------------------
      - name: Enforce test policy
        if: ${{ inputs.fail-on-issues && failure() }}
        run: |
          echo "üî¥ TEST FAILED"
          echo "Failing pipeline because fail-on-issues=true"
          echo "Review the test output above for details."
          exit 1

      # ------------------------------------------------------
      # Step 8: Upload test artifacts
      # ------------------------------------------------------
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.workflow }}-artifacts
          path: |
            ${{ inputs.working-directory }}/.coverage
            ${{ inputs.working-directory }}/coverage.xml
            ${{ inputs.working-directory }}/pytest-results.xml
            ${{ inputs.working-directory }}/test-results.*
          retention-days: 7

      # ------------------------------------------------------
      # Step 9: Test summary
      # ------------------------------------------------------
      - name: Test summary
        if: always()
        run: |
          echo "üìä TEST SUMMARY"
          echo "==============="
          echo "Test workflow: ${{ github.workflow }}"
          echo "Python version: ${{ inputs.python-version }}"
          echo "Working directory: ${{ inputs.working-directory }}"
          echo "Dependencies source: setup-environment"
          echo "Cache key: ${{ inputs.cache-key }}"
          echo ""
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ TEST PASSED"
            echo "Ready for next pipeline phase"
          else
            echo "‚ùå TEST FAILED"
            echo "Check test logs for details"
          fi