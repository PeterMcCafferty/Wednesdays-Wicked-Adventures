# ============================================================
# SMOKE TEST WORKFLOW
#
# Goal: Verify the application starts and basic functionality works
# ============================================================
name: Smoke Test

on:
  workflow_call:
    inputs:
      python-version:
        required: true
        type: string
      working-directory:
        required: true
        type: string
      dependencies-installed:
        required: true
        type: boolean
      cache-key:
        required: true
        type: string

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      # Restaurar cache de depend√™ncias do setup
      - name: Restore Python dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            /opt/hostedtoolcache/Python
          key: ${{ inputs.cache-key }}

      - name: Validate environment precondition
        if: ${{ !inputs.dependencies-installed }}
        run: |
          echo "‚ùå Smoke test requires dependencies to be installed first"
          exit 1

      - name: Run application smoke test
        working-directory: ${{ inputs.working-directory }}
        env:
          FLASK_ENV: testing
        run: |
          echo "üö¨ Running smoke test..."

          python << 'EOF'
          import sys

          try:
              from app import create_app

              app = create_app("testing")
              print("‚úÖ Flask app created")

              with app.test_client() as client:
                  response = client.get("/")
                  print(f"‚úÖ Root endpoint returned HTTP {response.status_code}")

              print("üéâ SMOKE TEST PASSED")

          except Exception as e:
              print(f"‚ùå SMOKE TEST FAILED: {e}")
              sys.exit(1)
          EOF
