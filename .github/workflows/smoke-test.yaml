# smoke-test.yaml
name: Smoke Test

on:
  workflow_call:
    inputs:
      python-version:
        required: true
        type: string
      working-directory:
        required: true
        type: string
      dependencies-installed:
        required: true
        type: string
      cache-key:
        required: true
        type: string
      # ‚¨áÔ∏è I explicitly pass these paths from setup to avoid hardcoding
      python-root:
        required: true
        type: string
      workspace-path:
        required: true
        type: string

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
      
      # I only restore the cache generated by setup-environment
      - name: Restore Python dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            /opt/hostedtoolcache/Python
          key: ${{ inputs.cache-key }}

      - name: Validate setup stage was executed
        if: ${{ inputs.dependencies-installed != 'true' }}
        run: |
          echo "‚ùå This smoke test requires setup-environment to run first"
          exit 1

      - name: Run Smoke Test with configured PYTHONPATH
        working-directory: ${{ inputs.working-directory }}
        env:
          FLASK_ENV: testing
          DATABASE_URL: "sqlite:///:memory:"
          SECRET_KEY: "smoke-test-temp-key-123"
          # ‚¨áÔ∏è I configure PYTHONPATH explicitly using setup outputs
          PYTHONPATH: "${{ inputs.python-root }}:${{ inputs.workspace-path }}"
        run: |
          echo "üö¨ SMOKE TEST - Starting..."
          echo "PYTHONPATH from setup: $PYTHONPATH"
          echo "Python root: ${{ inputs.python-root }}"
          echo "Workspace path: ${{ inputs.workspace-path }}"
          
          # TEST 1: Basic structure validation
          echo "1. Checking project structure..."
          if [ ! -d "main" ]; then
            echo "‚ùå 'main' directory not found"
            exit 1
          fi
          
          if [ ! -f "main/app/__init__.py" ]; then
            echo "‚ùå main/app/__init__.py not found"
            echo "Searching for __init__.py files..."
            find . -name "__init__.py" -type f
            exit 1
          fi
          
          echo "‚úÖ Basic structure looks correct"

          echo "üö¨ SMOKE TEST - Validating main.app structure"
          echo "=============================================="
          echo "Working directory: $(pwd)"
          echo "PYTHONPATH: $PYTHONPATH"
          
          # Validate expected directory layout
          if [ ! -d "main/app" ]; then
            echo "‚ùå ERROR: main/app directory not found"
            echo "Current directory contents:"
            ls -la
            exit 1
          fi
          
          echo "‚úÖ main/app structure confirmed"
          
          # Main smoke test logic
          python << 'EOF'
          import sys
          import os
          
          print("\nPython sys.path (first entries):")
          for path in sys.path[:5]:
              print(f"  {path}")
          
          print(f"\nCurrent working directory: {os.getcwd()}")
          print("Directory contents:")
          for item in os.listdir('.'):
              if os.path.isdir(item):
                  print(f"  üìÅ {item}/")
              elif item.endswith('.py'):
                  print(f"  üìÑ {item}")
          
          print("\nüîç Importing main.app...")
          try:
              from main.app import create_app
              print("‚úÖ Successfully imported create_app from main.app")
              
              # Attempt to create the Flask application
              print("\nüîß Creating Flask application...")
              try:
                  app = create_app("testing")
                  print(f"‚úÖ Flask app created successfully: {app.name}")
                  print(f"   Config class: {app.config.__class__.__name__}")
              except Exception as e:
                  print(f"‚ö†Ô∏è Failed to create app using 'testing' config: {e}")
                  print("Falling back to default configuration...")
                  app = create_app()
                  print(f"‚úÖ App created with default config: {app.name}")
              
              # Minimal validation
              print("\nüìã Basic application checks:")
              print(f"   'main' blueprint registered: {'main' in app.blueprints if hasattr(app, 'blueprints') else 'N/A'}")
              print(f"   TESTING mode enabled: {app.config.get('TESTING', False)}")
              
              print("\nüéâ SMOKE TEST PASSED")
              print("‚úÖ Dependencies were restored from setup stage")
              print("‚úÖ main.app import works correctly")
              print("‚úÖ Flask app can be instantiated")
              print("‚úÖ Application structure is valid")
              
          except ImportError as e:
              print("‚ùå FAILED: Unable to import main.app")
              print(f"Error: {e}")
              print("\nüí° Troubleshooting checklist:")
              print("1. Ensure main/__init__.py exists")
              print("2. Ensure main/app/__init__.py exists")
              print("3. Verify PYTHONPATH includes flask_app/src")
              print(f"   Current PYTHONPATH: {os.environ.get('PYTHONPATH', 'not set')}")
              exit(1)
          
          except Exception as e:
              print(f"‚ùå Unexpected error: {type(e).__name__}: {e}")
              exit(1)
          EOF
