# ============================================================
# SAST SECURITY SCAN WORKFLOW
# ============================================================
name: SAST Security Scan

on:
  workflow_call:
    inputs:
      project-root:
        description: "Project root directory from setup-environment"
        required: true
        type: string
      venv-path:
        description: "Path to virtual environment"
        required: true
        type: string
      python-path:
        description: "Path to Python executable in venv"
        required: true
        type: string
      fail-on-issues:
        description: "Fail the pipeline if high/medium issues found"
        required: true
        type: string
        default: "true"
      config-path:
        description: "Path to Bandit config file"
        required: false
        type: string
        default: ".bandit.yml"
      requirements-hash:
        description: "Hash of requirements.txt for cache key"
        required: true
        type: string
      python-version:
        description: "Python version for cache key"
        required: true
        type: string

jobs:
  bandit-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      VENV_PYTHON: ${{ inputs.python-path }}
      VENV_PIP: ${{ inputs.venv-path }}/bin/pip
      VENV_PATH: ${{ inputs.venv-path }}

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. RESTAURAR CACHE DO VENV
      - name: Restore virtual environment cache
        id: restore-venv-cache
        uses: actions/cache@v4
        with:
          path: ${{ inputs.venv-path }}
          key: venv-${{ runner.os }}-python-${{ inputs.python-version }}-deps-${{ inputs.requirements-hash }}
          restore-keys: |
            venv-${{ runner.os }}-python-${{ inputs.python-version }}-deps-

      # 2.5. DEBUG: Verificar cache
      - name: Debug cache status
        run: |
          echo "üß™ Cache restore result:"
          echo "Cache hit: ${{ steps.restore-venv-cache.outputs.cache-hit }}"
          echo "Expected venv path: $VENV_PATH"
          echo "Venv exists? $( [ -d "$VENV_PATH" ] && echo "YES" || echo "NO" )"
          echo "Listing directory:"
          ls -la "$(dirname "$VENV_PATH")" || true
      
      # 3. VERIFICAR VENV
      - name: Verify virtual environment
        run: |
          echo "üîç Verifying virtual environment..."
          
          if [ ! -d "$VENV_PATH" ]; then
            echo "‚ùå ERROR: Virtual environment not found at: $VENV_PATH"
            exit 1
          fi
          
          if [ ! -f "$VENV_PYTHON" ]; then
            echo "‚ùå ERROR: Python not found in venv: $VENV_PYTHON"
            exit 1
          fi
          
          echo "‚úÖ Venv verified:"
          echo "   Path: $VENV_PATH"
          echo "   Python: $VENV_PYTHON"
          echo "   Version: $($VENV_PYTHON --version)"
      
      # 4. INSTALAR BANDIT SE NECESS√ÅRIO
      - name: Install Bandit if needed
        run: |
          echo "üì¶ Checking/installing Bandit..."
          
          # Verificar se bandit est√° instalado no venv
          if $VENV_PIP show bandit >/dev/null 2>&1; then
            bandit_version=$($VENV_PIP show bandit | grep "^Version:" | cut -d: -f2 | xargs)
            echo "‚úÖ Bandit already installed in venv: version $bandit_version"
          else
            echo "‚ö†Ô∏è Bandit not found in venv, installing..."
            $VENV_PIP install bandit
            echo "‚úÖ Bandit installed in venv"
          fi
      
      # 5. EXECUTAR BANDIT SCAN
      - name: Run Bandit Security Scan
        id: bandit-scan
        continue-on-error: ${{ inputs.fail-on-issues != 'true' }}
        run: |
          echo "üîç Running Bandit security scan..."
          
          # Ir para o diret√≥rio correto
          echo "üìÇ Changing to project directory: ${{ inputs.project-root }}"
          cd "${{ inputs.project-root }}"
          echo "üìç Current directory: $(pwd)"
          
          # Configura√ß√£o do Bandit
          if [ ! -f "${{ inputs.config-path }}" ]; then
            echo "‚ÑπÔ∏è Using default Bandit settings"
            CONFIG_ARG=""
          else
            CONFIG_ARG="-c ${{ inputs.config-path }}"
          fi
          
          # Executar Bandit usando Python do venv
          echo "üöÄ Executing: $VENV_PYTHON -m bandit $CONFIG_ARG -r . -f json -o bandit-results.json"
          $VENV_PYTHON -m bandit $CONFIG_ARG -r . -f json -o bandit-results.json
          
          # Processar resultados
          if [ -f "bandit-results.json" ]; then
            echo "‚úÖ Scan completed successfully"
            
            # Instalar jq se necess√°rio para processar JSON
            if ! command -v jq &> /dev/null; then
              sudo apt-get update && sudo apt-get install -y jq
            fi
            
            HIGH=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-results.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' bandit-results.json 2>/dev/null || echo "0")
            LOW=$(jq '[.results[] | select(.issue_severity == "LOW")] | length' bandit-results.json 2>/dev/null || echo "0")
            
            echo "üìä Security Scan Results:"
            echo "   HIGH severity issues: $HIGH"
            echo "   MEDIUM severity issues: $MEDIUM"
            echo "   LOW severity issues: $LOW"
            
            if [ "$HIGH" -gt 0 ] || [ "$MEDIUM" -gt 0 ]; then
              echo "‚ö†Ô∏è Found $HIGH HIGH and $MEDIUM MEDIUM severity issues"
              
              if [ "${{ inputs.fail-on-issues }}" = "true" ]; then
                echo "‚ùå Failing pipeline due to security issues"
                exit 1
              else
                echo "‚ö†Ô∏è Continuing pipeline (fail-on-issues is false)"
              fi
            else
              echo "‚úÖ No HIGH or MEDIUM severity issues found"
            fi
            
            # Mostrar resumo das issues
            echo ""
            echo "üîç Issue summary:"
            jq -r '.results[] | "\(.issue_severity): \(.issue_text) (in \(.filename):\(.line_number))"' bandit-results.json 2>/dev/null | head -10 || true
            
          else
            echo "‚ùå No results file generated"
            exit 1
          fi
      
      # 6. UPLOAD RESULTS
      - name: Upload Security Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: ${{ inputs.project-root }}/bandit-results.json
          retention-days: 30