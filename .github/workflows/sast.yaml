# ============================================================
# SAST SECURITY SCAN WORKFLOW
# ============================================================
name: SAST Security Scan

on:
  workflow_call:
    inputs:
      python-version:
        description: "Python version to use"
        required: true
        type: string
        default: "3.11"
      working-directory:
        description: "Directory where the project resides"
        required: true
        type: string
        default: "."
      fail-on-issues:
        description: "Fail the pipeline if high/medium issues found"
        required: true
        type: boolean
        default: true
      dependencies-installed:
        description: "Indicates if dependencies are already installed from setup-environment"
        required: false
        type: boolean
        default: false
      cache-key:
        description: "Cache key from setup-environment for dependency cache"
        required: false
        type: string
        default: ""
      config-path:
        description: "Path to Bandit config file"
        required: false
        type: string
        default: ".bandit.yml"

jobs:
  bandit-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 2. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
      
      # 3. Restore Python dependencies cache
      - name: Restore Python dependencies cache
        if: ${{ inputs.dependencies-installed && inputs.cache-key != '' }}
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            /opt/hostedtoolcache/Python
          key: ${{ inputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-python-${{ inputs.python-version }}-deps-
      
      # 4. Verify dependencies or install Bandit
      - name: Install Bandit (or verify dependencies)
        run: |
          if [ "${{ inputs.dependencies-installed }}" = "true" ] && [ -n "${{ inputs.cache-key }}" ]; then
            echo "‚úÖ Using dependencies from setup-environment"
            echo "Checking if bandit is available..."
            
            if pip show bandit >/dev/null 2>&1; then
              echo "‚úÖ Bandit already installed via setup-environment"
              bandit_version=$(pip show bandit | grep "^Version:" | cut -d: -f2 | xargs)
              echo "   Bandit version: $bandit_version"
            else
              echo "‚ö†Ô∏è Bandit not found in cache, installing..."
              pip install bandit
            fi
          else
            echo "‚ö†Ô∏è Running in standalone mode (without setup-environment)"
            echo "Installing Bandit and dependencies..."
            python -m pip install --upgrade pip
            pip install bandit
          fi
      
      # 5. Run Bandit Scan
      - name: Run Bandit Security Scan
        working-directory: ${{ inputs.working-directory }}
        id: bandit-scan
        continue-on-error: ${{ !inputs.fail-on-issues }}
        run: |
          # Check config file
          if [ ! -f "${{ inputs.config-path }}" ]; then
            echo "‚ÑπÔ∏è Using default Bandit settings"
            CONFIG_ARG=""
          else
            CONFIG_ARG="-c ${{ inputs.config-path }}"
          fi
          
          # Run Bandit with exit code control
          echo "üîç Running Bandit security scan..."
          echo "Using dependencies from: ${{ inputs.dependencies-installed && 'setup-environment' || 'standalone installation' }}"
          
          bandit $CONFIG_ARG -r . -f json -o bandit-results.json
          
          # Check if results file was created
          if [ -f "bandit-results.json" ]; then
            echo "‚úÖ Scan completed successfully"
            
            # Simple count using jq (installed by default)
            HIGH=$(jq '[.results[] | select(.issue_severity == "HIGH")] | length' bandit-results.json || echo "0")
            MEDIUM=$(jq '[.results[] | select(.issue_severity == "MEDIUM")] | length' bandit-results.json || echo "0")
            LOW=$(jq '[.results[] | select(.issue_severity == "LOW")] | length' bandit-results.json || echo "0")
            
            echo "üìä Scan Results:"
            echo "   HIGH severity: $HIGH"
            echo "   MEDIUM severity: $MEDIUM"
            echo "   LOW severity: $LOW"
            
            if [ "$HIGH" -gt 0 ] || [ "$MEDIUM" -gt 0 ]; then
              echo "‚ö†Ô∏è Found $HIGH HIGH and $MEDIUM MEDIUM severity issues"
              
              if [ "${{ inputs.fail-on-issues }}" = "true" ]; then
                echo "‚ùå Failing pipeline due to security issues"
                exit 1
              else
                echo "‚ö†Ô∏è Continuing pipeline (fail-on-issues is false)"
              fi
            else
              echo "‚úÖ No HIGH or MEDIUM severity issues found"
            fi
          else
            echo "‚ùå No results file generated"
            exit 1
          fi
      
      # 6. Upload results (always, even if failed)
      - name: Upload Security Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-results
          path: ${{ inputs.working-directory }}/bandit-results.json
          retention-days: 30  # Keep security logs longer